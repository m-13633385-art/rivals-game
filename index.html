<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rivals: 1v1 Multiplayer</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-color: #0b0b10; --panel-bg: #161620; --text-main: #e2e2e2;
            --accent-blue: #3b82f6; --accent-purple: #8b5cf6; --accent-red: #ef4444;
            --accent-green: #10b981; --btn-bg: #222230; --btn-hover: #33334a;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-main); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        h1, h2 { text-align: center; text-transform: uppercase; letter-spacing: 2px;}
        
        .screen { display: none; width: 100%; max-width: 900px; flex-direction: column; gap: 20px; }
        
        /* Network UI */
        #network-panel { background: #111; padding: 20px; border: 2px solid var(--accent-blue); border-radius: 8px; text-align: center; }
        .code-display { font-size: 32px; font-weight: bold; color: var(--accent-purple); letter-spacing: 5px; margin: 10px 0; user-select: all;}
        .join-input { width: 60%; padding: 15px; font-size: 20px; text-align: center; background: #000; color: white; border: 2px solid #444; border-radius: 8px; text-transform: uppercase;}
        
        /* Loadout */
        .category-box { background: var(--panel-bg); padding: 15px; border-radius: 8px; border-left: 4px solid var(--accent-blue); }
        select { width: 100%; padding: 10px; background: var(--btn-bg); color: white; border: 1px solid #444; border-radius: 4px; font-size: 16px; margin-top: 10px;}
        .primary-btn { background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple)); color: white; border: none; padding: 15px; font-size: 18px; font-weight: bold; cursor: pointer; border-radius: 8px; text-transform: uppercase; width: 100%; transition: 0.2s; margin-top: 10px; }
        .primary-btn:hover:not(:disabled) { filter: brightness(1.2); transform: scale(1.02); }
        .primary-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Combat UI */
        #hud-container { display: flex; justify-content: space-between; gap: 20px; }
        .agent-panel { flex: 1; background: var(--panel-bg); padding: 20px; border-radius: 8px; position: relative; }
        .player-panel { border-top: 4px solid var(--accent-blue); }
        .enemy-panel { border-top: 4px solid var(--accent-red); }
        .health-bar-container { width: 100%; background: #222; height: 25px; border-radius: 4px; margin: 10px 0; position: relative; }
        .health-bar { height: 100%; transition: width 0.2s ease-out; }
        #p-hp-bar { background: var(--accent-blue); width: 100%; }
        #e-hp-bar { background: var(--accent-red); width: 100%; }
        .hp-text { position: absolute; top: 2px; left: 10px; font-weight: bold; font-size: 14px; text-shadow: 1px 1px 2px black;}
        
        #arena-status { text-align: center; font-size: 20px; font-weight: bold; padding: 15px; background: #111; border: 2px solid #333; border-radius: 8px; color: var(--accent-purple);}
        #turn-indicator { font-size: 24px; color: var(--accent-green); margin-top: 10px; display: block;}
        
        #log-box { background: #050508; border: 1px solid #333; height: 300px; padding: 15px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 14px; border-radius: 8px; }
        .controls-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        button.action-btn { background: var(--btn-bg); color: var(--text-main); border: 1px solid #444; padding: 15px; font-size: 15px; font-weight: bold; cursor: pointer; border-radius: 4px; transition: 0.2s; }
        button.action-btn:hover:not(:disabled) { background: var(--btn-hover); border-color: var(--accent-blue); }
        button.action-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        .log-p { color: var(--accent-blue); }
        .log-e { color: var(--accent-red); }
        .log-dmg { color: var(--accent-green); font-weight: bold;}
        .log-sys { color: #888; font-style: italic;}
    </style>
</head>
<body>

<div id="lobby-screen" class="screen" style="display: flex;">
    <h1>Rivals: P2P Multiplayer</h1>
    
    <div id="network-panel">
        <h2>Host a Private Match</h2>
        <button class="primary-btn" id="btn-host" onclick="hostGame()">CREATE ROOM CODE</button>
        <div id="host-code-zone" style="display: none; margin-top: 20px;">
            <div style="color: #aaa;">Send this code to your friend:</div>
            <div class="code-display" id="room-code-display">LOADING...</div>
            <div style="color: var(--accent-green); animation: pulse 1.5s infinite;">Waiting for opponent to join...</div>
        </div>
    </div>

    <div id="network-panel">
        <h2>Join a Friend</h2>
        <input type="text" id="join-code-input" class="join-input" placeholder="ENTER 5-LETTER CODE" maxlength="5">
        <button class="primary-btn" id="btn-join" style="background: #2d2d1a;" onclick="joinGame()">JOIN ROOM</button>
        <div id="join-status" style="margin-top: 10px; color: #aaa;"></div>
    </div>
</div>

<div id="loadout-screen" class="screen">
    <h1 style="color: var(--accent-green);">CONNECTED!</h1>
    <h2>Select Your Loadout</h2>
    <div class="category-box">
        <select id="sel-primary">
            <option value="Assault Rifle">Assault Rifle (Mid Range)</option>
            <option value="Sniper">Sniper (Far Range)</option>
            <option value="Shotgun">Shotgun (Close Range)</option>
        </select>
    </div>
    <button class="primary-btn" id="btn-ready" onclick="lockLoadout()">LOCK IN & READY UP</button>
    <div id="ready-status" style="text-align: center; color: #aaa; margin-top: 10px;"></div>
</div>

<div id="combat-screen" class="screen">
    <div id="arena-status">
        DISTANCE: <span id="ui-range">MID RANGE</span>
        <div id="turn-indicator">WAITING...</div>
    </div>
    
    <div id="hud-container">
        <div class="agent-panel player-panel">
            <h2>YOU</h2>
            <div class="health-bar-container"><div id="p-hp-bar"></div><div class="hp-text" id="p-hp-text">150 / 150</div></div>
            <div style="font-size: 14px; color: #aaa;">Pri: <span id="p-pri"></span></div>
        </div>
        <div class="agent-panel enemy-panel">
            <h2>ENEMY</h2>
            <div class="health-bar-container"><div id="e-hp-bar"></div><div class="hp-text" id="e-hp-text">150 / 150</div></div>
            <div style="font-size: 14px; color: #aaa;">Pri: <span id="e-pri">???</span></div>
        </div>
    </div>

    <div id="log-box"></div>
    
    <div class="controls-grid">
        <button class="action-btn" id="btn-pri" onclick="takeTurn('primary')">Use Primary Gun</button>
        <button class="action-btn" id="btn-mel" onclick="takeTurn('melee')">Use Melee Strike</button>
        <button class="action-btn" onclick="takeTurn('dash-in')">► Dash Forward</button>
        <button class="action-btn" onclick="takeTurn('dash-out')">◄ Slide Back</button>
    </div>
</div>

<script>
    /* =========================================================================
       MULTIPLAYER NETWORKING (PeerJS)
       ========================================================================= */
    let peer = null;
    let conn = null;
    let myRole = ""; // 'host' or 'guest'
    let roomCode = "";

    // Generate a random 5-letter code for the room
    function generateCode() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        let code = '';
        for(let i=0; i<5; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
        return code;
    }

    function initPeer(id) {
        // We use a prefix to ensure PeerJS IDs are unique to your game
        peer = new Peer('RIVALS-' + id);
        
        peer.on('error', (err) => {
            alert("Network Error: " + err.type);
            document.getElementById("join-status").innerText = "Connection failed.";
        });
        return peer;
    }

    // HOST LOGIC
    function hostGame() {
        document.getElementById("btn-host").style.display = "none";
        document.getElementById("host-code-zone").style.display = "block";
        
        roomCode = generateCode();
        document.getElementById("room-code-display").innerText = roomCode;
        
        peer = initPeer(roomCode);
        myRole = "host";

        // Listen for guest connecting
        peer.on('connection', (connection) => {
            conn = connection;
            setupConnection();
        });
    }

    // GUEST LOGIC
    function joinGame() {
        roomCode = document.getElementById("join-code-input").value.toUpperCase();
        if(roomCode.length !== 5) return alert("Code must be 5 letters.");
        
        document.getElementById("join-status").innerText = "Connecting...";
        
        peer = initPeer(generateCode() + 'G'); // Guest gets random ID
        myRole = "guest";

        peer.on('open', () => {
            conn = peer.connect('RIVALS-' + roomCode);
            setupConnection();
        });
    }

    // SHARED NETWORK LOGIC
    function setupConnection() {
        conn.on('open', () => {
            switchScreen('loadout-screen');
        });

        conn.on('data', (data) => {
            handleNetworkData(data);
        });
    }

    function sendData(dataObj) {
        if(conn && conn.open) {
            conn.send(dataObj);
        }
    }

    /* =========================================================================
       GAME STATE & LOGIC
       ========================================================================= */
    const weapons = {
        "Assault Rifle": { dmg: 24, acc: [0.6, 0.85, 0.5] },
        "Sniper": { dmg: 80, acc: [0.2, 0.6, 0.95] },
        "Shotgun": { dmg: 60, acc: [0.9, 0.2, 0.0] },
        "Katana": { dmg: 40, acc: [0.9, 0.0, 0.0] }
    };

    let p = { hp: 150, maxHp: 150, primary: "", ready: false };
    let e = { hp: 150, maxHp: 150, primary: "", ready: false };
    
    let currentRange = 1;
    let isMyTurn = false;
    const rangeNames = ["CLOSE QUARTERS", "MID RANGE", "LONG RANGE"];

    function switchScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
        document.getElementById(screenId).style.display = 'flex';
    }

    function log(msg, style = "") {
        const box = document.getElementById("log-box");
        box.innerHTML += `<div class="${style}">> ${msg}</div>`;
        box.scrollTop = box.scrollHeight;
    }

    function updateHUD() {
        document.getElementById("ui-range").innerText = rangeNames[currentRange];
        document.getElementById("p-hp-bar").style.width = `${Math.max(0, (p.hp / p.maxHp) * 100)}%`;
        document.getElementById("p-hp-text").innerText = `${p.hp} / ${p.maxHp}`;
        document.getElementById("e-hp-bar").style.width = `${Math.max(0, (e.hp / e.maxHp) * 100)}%`;
        document.getElementById("e-hp-text").innerText = `${e.hp} / ${e.maxHp}`;

        // Turn Management UI
        const indicator = document.getElementById("turn-indicator");
        const btns = document.querySelectorAll(".action-btn");
        
        if (p.hp <= 0 || e.hp <= 0) {
            indicator.innerText = p.hp <= 0 ? "DEFEAT" : "VICTORY!";
            indicator.style.color = p.hp <= 0 ? "var(--accent-red)" : "var(--accent-green)";
            btns.forEach(b => b.disabled = true);
        } else if (isMyTurn) {
            indicator.innerText = "YOUR TURN";
            indicator.style.color = "var(--accent-green)";
            btns.forEach(b => b.disabled = false);
        } else {
            indicator.innerText = "ENEMY IS THINKING...";
            indicator.style.color = "var(--accent-red)";
            btns.forEach(b => b.disabled = true);
        }
    }

    /* =========================================================================
       COMBAT & SYNCING
       ========================================================================= */
    function lockLoadout() {
        p.primary = document.getElementById("sel-primary").value;
        p.ready = true;
        document.getElementById("btn-ready").disabled = true;
        document.getElementById("ready-status").innerText = "Waiting for opponent...";
        
        // Tell the opponent we are ready and what gun we have
        sendData({ type: "ready", primary: p.primary });
        checkStartMatch();
    }

    function handleNetworkData(data) {
        // Opponent locked in their loadout
        if (data.type === "ready") {
            e.primary = data.primary;
            e.ready = true;
            checkStartMatch();
        }
        
        // Opponent took a turn
        if (data.type === "action") {
            processEnemyTurn(data);
        }
    }

    function checkStartMatch() {
        if (p.ready && e.ready) {
            document.getElementById("p-pri").innerText = p.primary;
            document.getElementById("e-pri").innerText = e.primary;
            
            // Host always goes first to prevent network desync
            isMyTurn = (myRole === "host"); 
            
            switchScreen('combat-screen');
            log("Match Started! First to 0 HP loses.", "log-sys");
            if(isMyTurn) log("You are the Host. You go first.", "log-sys");
            updateHUD();
        }
    }

    function takeTurn(action) {
        if (!isMyTurn) return;
        
        let resultPacket = { type: "action", action: action, newRange: currentRange, hit: false, dmg: 0, wepName: "" };

        // Handle Movement locally
        if (action === 'dash-in') {
            currentRange = Math.max(0, currentRange - 1);
            resultPacket.newRange = currentRange;
            log(`YOU dash forward! Distance: ${rangeNames[currentRange]}.`, "log-p");
        } else if (action === 'dash-out') {
            currentRange = Math.min(2, currentRange + 1);
            resultPacket.newRange = currentRange;
            log(`YOU slide backward! Distance: ${rangeNames[currentRange]}.`, "log-p");
        } else {
            // Handle Attacks locally
            let wepName = action === "primary" ? p.primary : "Katana";
            resultPacket.wepName = wepName;
            let acc = weapons[wepName].acc[currentRange];

            if (acc > 0) {
                let isCrit = Math.random() < 0.15;
                if (Math.random() <= (isCrit ? acc + 0.2 : acc)) {
                    let dmg = isCrit ? Math.floor(weapons[wepName].dmg * 1.5) : weapons[wepName].dmg;
                    e.hp -= dmg;
                    resultPacket.hit = true;
                    resultPacket.dmg = dmg;
                    log(`YOU fire your ${wepName}. <span class="log-dmg">Hits for ${dmg} DMG!</span>`, "log-p");
                } else {
                    log(`YOU fire your ${wepName} but miss!`, "log-p");
                }
            } else {
                log(`YOU try to use your ${wepName} but it's out of range!`, "log-p");
            }
        }

        // Send exactly what happened to the enemy so their screen updates
        sendData(resultPacket);
        
        // End our turn
        isMyTurn = false;
        updateHUD();
    }

    // Read the data packet the enemy sent and apply it to our screen
    function processEnemyTurn(data) {
        // Sync the range if they moved
        if (data.action === 'dash-in' || data.action === 'dash-out') {
            currentRange = data.newRange;
            let verb = data.action === 'dash-in' ? "dashes forward" : "slides backward";
            log(`ENEMY ${verb}! Distance: ${rangeNames[currentRange]}.`, "log-e");
        } else {
            // Take damage if they hit us
            if (data.hit) {
                p.hp -= data.dmg;
                log(`ENEMY fires their ${data.wepName}. <span class="log-dmg">Hits you for ${data.dmg} DMG!</span>`, "log-e");
            } else {
                log(`ENEMY fires their ${data.wepName} and misses!`, "log-e");
            }
        }

        // Now it's our turn
        isMyTurn = true;
        updateHUD();
    }
</script>
</body>
</html>
